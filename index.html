import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, Upload, Volume2, Music, Zap, Activity, SkipBack, SkipForward, Disc, Headphones } from 'lucide-react';

const App = () => {
  const [isPlaying, setIsPlaying] = useState(false);
  const [progress, setProgress] = useState(0);
  const [duration, setDuration] = useState(0);
  const [currentTime, setCurrentTime] = useState(0);
  const [volume, setVolume] = useState(0.8);
  const [fileName, setFileName] = useState("Waiting for Artifact...");
  const [audioData, setAudioData] = useState(new Array(40).fill(5));
  
  const audioRef = useRef(null);
  const fileInputRef = useRef(null);
  const analyzerRef = useRef(null);
  const animationRef = useRef(null);
  const audioContextRef = useRef(null);
  const sourceRef = useRef(null);

  // Initialize Web Audio API for Real-time Visualizer
  const initAudioContext = () => {
    if (!audioContextRef.current) {
      audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
      analyzerRef.current = audioContextRef.current.createAnalyser();
      analyzerRef.current.fftSize = 256;
      sourceRef.current = audioContextRef.current.createMediaElementSource(audioRef.current);
      sourceRef.current.connect(analyzerRef.current);
      analyzerRef.current.connect(audioContextRef.current.destination);
    }
  };

  const updateVisualizer = () => {
    if (isPlaying && analyzerRef.current) {
      const dataArray = new Uint8Array(analyzerRef.current.frequencyBinCount);
      analyzerRef.current.getByteFrequencyData(dataArray);
      
      // Map frequency data to our 40 bars
      const reducedData = [];
      const step = Math.floor(dataArray.length / 40);
      for (let i = 0; i < 40; i++) {
        reducedData.push(dataArray[i * step] / 2);
      }
      setAudioData(reducedData);
      animationRef.current = requestAnimationFrame(updateVisualizer);
    } else if (!isPlaying) {
      setAudioData(prev => prev.map(v => v * 0.9)); // Smooth decay
      if (audioData.some(v => v > 1)) {
        animationRef.current = requestAnimationFrame(updateVisualizer);
      }
    }
  };

  useEffect(() => {
    if (isPlaying) {
      animationRef.current = requestAnimationFrame(updateVisualizer);
    } else {
      cancelAnimationFrame(animationRef.current);
    }
    return () => cancelAnimationFrame(animationRef.current);
  }, [isPlaying]);

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      initAudioContext();
      const url = URL.createObjectURL(file);
      audioRef.current.src = url;
      setFileName(file.name);
      setIsPlaying(false);
      setProgress(0);
      if (audioContextRef.current.state === 'suspended') {
        audioContextRef.current.resume();
      }
    }
  };

  const onTimeUpdate = () => {
    const current = audioRef.current.currentTime;
    const total = audioRef.current.duration;
    setCurrentTime(current);
    setProgress((current / total) * 100);
  };

  const togglePlay = () => {
    if (!audioRef.current.src) return;
    initAudioContext();
    if (audioContextRef.current.state === 'suspended') {
      audioContextRef.current.resume();
    }

    if (isPlaying) {
      audioRef.current.pause();
    } else {
      audioRef.current.play();
    }
    setIsPlaying(!isPlaying);
  };

  const formatTime = (time) => {
    const mins = Math.floor(time / 60);
    const secs = Math.floor(time % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  return (
    <div className="min-h-screen bg-[#020202] text-zinc-100 flex flex-col items-center justify-center p-6 font-sans">
      
      {/* Background Ambience */}
      <div className="fixed inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-[#d4af37]/5 blur-[120px] rounded-full"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-[#d4af37]/5 blur-[120px] rounded-full"></div>
      </div>

      {/* Header Branding */}
      <div className="mb-10 flex flex-col items-center z-10">
        <div className="relative group">
          <div className="absolute inset-0 bg-[#d4af37]/20 blur-xl group-hover:bg-[#d4af37]/40 transition-all duration-700"></div>
          <div className="relative w-20 h-20 bg-black border border-[#d4af37]/30 flex items-center justify-center rounded-2xl mb-4 backdrop-blur-md">
            <span className="text-4xl font-black text-[#d4af37] drop-shadow-[0_0_10px_rgba(212,175,55,0.5)]">Ω</span>
          </div>
        </div>
        <h1 className="text-xl font-black tracking-[0.6em] uppercase text-white ml-2">BlackSmith-Ω</h1>
        <p className="text-[10px] text-[#d4af37]/50 uppercase tracking-[0.4em] font-bold mt-2">Sonic Architecture Protocol</p>
      </div>

      {/* Main Player UI */}
      <div className="max-w-md w-full bg-[#0a0a0a] border border-white/5 rounded-[40px] p-8 shadow-2xl z-10 relative overflow-hidden backdrop-blur-3xl">
        
        {/* Decorative Grid */}
        <div className="absolute inset-0 opacity-10 pointer-events-none" style={{ backgroundImage: 'radial-gradient(#d4af37 0.5px, transparent 0.5px)', backgroundSize: '20px 20px' }}></div>

        {/* Track Info Card */}
        <div className="relative bg-white/[0.03] border border-white/5 rounded-3xl p-6 mb-8 flex flex-col items-center group overflow-hidden">
          <div className={`absolute inset-0 bg-gradient-to-br from-[#d4af37]/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500`}></div>
          
          <div className="relative w-16 h-16 mb-4 flex items-center justify-center">
             <div className={`absolute inset-0 bg-[#d4af37]/10 rounded-full ${isPlaying ? 'animate-ping' : ''}`}></div>
             <div className="relative w-full h-full bg-black border border-white/10 rounded-full flex items-center justify-center shadow-2xl">
                <Disc className={`w-8 h-8 text-[#d4af37] ${isPlaying ? 'animate-[spin_3s_linear_infinite]' : ''}`} />
             </div>
          </div>
          
          <h2 className="relative text-sm font-bold text-white truncate w-full text-center px-4 mb-1">{fileName}</h2>
          <div className="flex items-center gap-2 opacity-40 text-[9px] uppercase tracking-widest font-black">
            <Headphones className="w-3 h-3" />
            <span>Mastered Audio Output</span>
          </div>
        </div>

        {/* Real-time Frequency Visualizer */}
        <div className="flex items-end justify-center gap-[2px] h-24 mb-10 px-4">
          {audioData.map((height, i) => (
            <div 
              key={i} 
              className={`w-1 rounded-full transition-all duration-75 ${isPlaying ? 'bg-[#d4af37]' : 'bg-zinc-800'}`} 
              style={{ 
                height: `${Math.max(8, height)}%`,
                opacity: 0.3 + (height / 100),
                boxShadow: isPlaying && height > 40 ? '0 0 15px rgba(212, 175, 55, 0.4)' : 'none'
              }}
            ></div>
          ))}
        </div>

        {/* Playback Controls */}
        <div className="space-y-8">
          {/* Progress Section */}
          <div>
            <div className="flex justify-between text-[10px] text-zinc-500 mb-3 font-mono font-bold tracking-tighter">
              <span className={isPlaying ? "text-[#d4af37]" : ""}>{formatTime(currentTime)}</span>
              <span>{formatTime(duration)}</span>
            </div>
            <div className="relative h-1.5 w-full bg-white/5 rounded-full overflow-hidden group cursor-pointer">
              <div 
                className="absolute top-0 left-0 h-full bg-[#d4af37] shadow-[0_0_10px_rgba(212,175,55,0.8)] transition-all duration-150"
                style={{ width: `${progress}%` }}
              ></div>
              <input 
                type="range"
                min="0"
                max="100"
                value={progress}
                onChange={(e) => {
                  const newTime = (e.target.value / 100) * audioRef.current.duration;
                  audioRef.current.currentTime = newTime;
                }}
                className="absolute inset-0 opacity-0 cursor-pointer w-full"
              />
            </div>
          </div>

          {/* Buttons */}
          <div className="flex items-center justify-between">
            <button className="p-3 text-zinc-600 hover:text-[#d4af37] transition-all">
              <SkipBack className="w-5 h-5" fill="currentColor" />
            </button>
            
            <button 
              onClick={togglePlay}
              className="relative w-24 h-24 flex items-center justify-center group"
            >
              <div className={`absolute inset-0 bg-[#d4af37]/20 rounded-full blur-xl group-hover:bg-[#d4af37]/30 transition-all ${isPlaying ? 'scale-110' : 'scale-90'}`}></div>
              <div className="absolute inset-0 border border-[#d4af37]/30 rounded-full scale-110 group-hover:scale-125 transition-all duration-500"></div>
              <div className="relative w-20 h-20 bg-[#d4af37] text-black rounded-full flex items-center justify-center shadow-[0_0_40px_rgba(212,175,55,0.3)] hover:scale-105 active:scale-95 transition-all">
                {isPlaying ? 
                  <Pause className="w-8 h-8" fill="black" strokeWidth={3} /> : 
                  <Play className="w-8 h-8 ml-1" fill="black" strokeWidth={3} />
                }
              </div>
            </button>

            <button className="p-3 text-zinc-600 hover:text-[#d4af37] transition-all">
              <SkipForward className="w-5 h-5" fill="currentColor" />
            </button>
          </div>

          {/* Volume & Upload */}
          <div className="flex items-center justify-between pt-6 border-t border-white/5">
            <div className="flex items-center gap-4 bg-white/[0.03] px-4 py-2 rounded-2xl border border-white/5">
              <Volume2 className="w-4 h-4 text-[#d4af37]" />
              <input 
                type="range"
                min="0"
                max="1"
                step="0.01"
                value={volume}
                onChange={(e) => {
                  const val = parseFloat(e.target.value);
                  setVolume(val);
                  audioRef.current.volume = val;
                }}
                className="w-16 h-1 bg-white/10 rounded-full appearance-none cursor-pointer accent-[#d4af37]"
              />
            </div>
            
            <button 
              onClick={() => fileInputRef.current.click()}
              className="bg-white/5 hover:bg-[#d4af37] text-zinc-400 hover:text-black px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all border border-white/5 flex items-center gap-2"
            >
              <Upload className="w-3 h-3" />
              Upload Ω
            </button>
          </div>
        </div>

        <audio 
          ref={audioRef}
          onTimeUpdate={onTimeUpdate}
          onLoadedMetadata={() => setDuration(audioRef.current.duration)}
          onEnded={() => setIsPlaying(false)}
          className="hidden"
        />
        <input 
          type="file" 
          ref={fileInputRef} 
          className="hidden" 
          accept="audio/*"
          onChange={handleFileUpload}
        />
      </div>

      {/* Logic Status Footer */}
      <div className="mt-12 flex flex-col items-center gap-3 opacity-20">
        <div className="flex gap-8">
          <Zap className="w-4 h-4" />
          <Activity className="w-4 h-4" />
          <Music className="w-4 h-4" />
        </div>
        <p className="text-[9px] uppercase tracking-[0.5em] font-black text-center">
          BlackSmith-Ω Audio Protocol • v2.0 Standard
        </p>
      </div>

    </div>
  );
};

export default App;
